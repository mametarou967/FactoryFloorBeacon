# システム構成

## 機器構成

```
[担当者]
  └── MM-BLEBC8N（BLEビーコン）を携帯
        │ iBeacon advertising（UUID で個人識別）
        ▼
[Raspberry Pi Zero 2 WH × 6台]（各出入口に1台ずつ設置 / 2階: 3台、3階: 3台）
  └── BLEスキャン → 入退出イベントをローカルに記録
        │
        ▼
[各Pi のローカルストレージ]
  └── 3ヶ月分のデータを蓄積
        │  ※運用終了後に手動回収（PC持参 or USBメモリ）
        ▼
[集計・確認] Python + Plotly → report.html / report.csv / graphs/*.png
```

## ビーコン仕様（MM-BLEBC8N）

| 項目 | 内容 |
|------|------|
| プロトコル | iBeacon（BLE 4.2） |
| RF POWER | レベル1（-30dBm）〜レベル8（4dBm）、初期値: レベル7（0dBm）、**採用値: レベル6（-4dBm）** |
| 送信間隔 | 100ms〜10,000ms（設定可能）、初期値: 500ms、**採用値: 500ms（変更なし）** |
| 送信距離 | 最大約100m（出力レベル設定次第） |
| 電池 | CR2032 × 2個 |
| 電池寿命 | 数ヶ月〜約2年（設定次第） |
| 設定アプリ | SSS-825（Android専用） |

## 開発・検証フロー

| ステップ | 構成 | 目的 |
|----------|------|------|
| Step 1 | Raspberry Pi 5 × 1 + MM-BLEBC8N × 2 | BLEスキャン基本動作確認（開発機） |
| Step 2 | Raspberry Pi Zero 2 WH × 2 + MM-BLEBC8N × 2 | 実機での出入り検知確認 |
| Step 3 | Raspberry Pi Zero 2 WH × 6 + MM-BLEBC8N × 担当者分 | 実環境での本番運用 |

> 現在の作業PCは Raspberry Pi 5。開発・初期テストはこの機器上で行う。

## 設計方針

- Raspberry Pi での BLE スキャンには `bleak`（Python）を使用予定
- データ保存: CSV形式（`events.csv`）、列構成: `timestamp, scanner_id, uuid, rssi`
- レポート生成: Python + Plotly（インタラクティブHTMLグラフ）
- UUID↔担当者名のマッピングは `person_map.csv` で管理
  - 例: `uuid, name`
  - ビーコン設定時に作成し、レポート生成スクリプトが参照する
- UUIDプレフィックスフィルタ: スキャナーは `ffb00000` で始まるUUIDのみ処理し、スマートフォン等の無関係なBLEデバイスを除外する

## 通過検知ロジック（タイムアウト方式）

各Raspberry Piは以下のロジックで「通過イベント」を記録する。

1. BLEスキャンを継続的に実行し、検知したビーコンのRSSIと最終検知時刻を追跡する
2. 最終検知から **BEACON_TIMEOUT（10秒）** 経過しても受信がない場合、圏外に出たと判定する
3. 圏外判定時にピークRSSIが MIN_PEAK_RSSI（-80dBm）以上であれば通過イベントをローカルに記録する

> **採用背景**: RSSIピーク検出方式は静置ビーコンのRSSIゆらぎ（±10〜20dBm）で誤発火するため廃止。
> タイムアウト方式は「20パケット連続ロスト ＝ 圏外」という確実な判定ができる。
> イベントのタイムスタンプは実際の通過時刻より最大10秒遅れるが、時間帯・日別集計では誤差の範囲内。

## フロア移動の判定（レポート生成時）

各Piのログを統合し、以下のルールでフロア移動を推定する。

- 同一人物（UUID）が **10分以内** に異なるフロアの出入口で検知された場合、フロア移動と判定する
  - 最短移動時間: 約30秒（急ぎ足）。時間窓は調整可能なパラメータとして実装する。
- 例: 2階出入口 → 3階出入口（10分以内）＝ 2階→3階への移動

## 未確定事項

- [x] スキャナー機器: Raspberry Pi Zero 2 WH（BLE 4.2内蔵、小型・安価）、計6台（2階: 3台、3階: 3台）
- [x] 電源確保: 各出入口でコンセント取得の見込み
- [x] 入退出判定: タイムアウト方式を採用（RSSIピーク検出方式は誤発火のため廃止）
- [x] データ保存フォーマット: CSV（人間が直接読める、トラブル時の確認が容易）
